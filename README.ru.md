# OTC смарт‑контракт (Proof of Capital Infrastructure)

Инфраструктурный EVM‑контракт для OTC‑поставок в технологии Proof of Capital. Контракт служит безопасной прослойкой между инвестором и администратором DAO при покупке долей DAO за utility‑токены. Поддерживает пополнение коллатералом или сразу лаунч‑токеном, поставку по партиям и защищенные исходы: поставка в конечное место, возврат/выкуп по оговоренной цене, либо возврат при таймауте.

Область применения:
- пресейлы/OTC, где участники «скидываются» коллатералом и получают поставку лаунч‑токена;
- безопасная поставка в конечный адрес (DAO/трезори/кастодиан), подтверждаемая инвестором;
- частичная/поштучная поставка по заранее зафиксированному графику и ценам партий.

Внимание: ниже приведена спецификация/README. Названия функций и эвентов примерные — синхронизируйте их с фактическим кодом.

## Термины

- Collateral (коллатерал): токен, которым инвестор оплачивает покупку (например, стейблкоин).
- Launch (лаунч): токен запуска/распределения, который поставляется инвестору/в конечное место.
- Поставка (delivery): процесс загрузки лаунч‑токена на контракт и/или дальнейшее перемещение в конечное место по подтверждению инвестора.
- Партии (tranches): заранее определенные доли поставки с отдельными ценами/объемами/дедлайнами.
- Конечное место (destination): адрес, куда по plan‑A должны уйти токены (например, DAO‑трезори).
- Buyback (обратный выкуп): право администратора выкупить у инвестора активы по заранее заявленной цене при отказе инвестора.

## Роли и права

- Инвестор:
  - пополнение коллатералом;
  - подтверждение или отказ от предложенного конечного адреса;
  - инициирование вывода при истечении лока/таймауте.
- Администратор (оператор OTC):
  - конфигурация контракта при деплое (адреса токенов, график партий, цены, сроки, buyback‑параметры);
  - внесение лаунч‑токена для поставки;
  - предложение конечного адреса;
  - выполнение buyback в установленные сроки.
- (Опционально) DAO/Кастодиан:
  - получает поставку после подтверждения инвестором.

Рекомендуется модель Ownable/AccessControl; отдельную роль OPERATOR можно отделить от владельца.

## Сценарии и потоки

1) Пополнение
- Вариант A — пополнение коллатералом:
  - инвестор вносит коллатерал;
  - администратор вносит лаунч по графику партий;
  - контракт отслеживает, какое количество лаунча соответствует внесенному коллатералу по ценам партий.
- Вариант B — пополнение лаунчем:
  - администратор сразу вносит весь лаунч;
  - поставка условно считается «загруженной»; остается маршрут в конечное место после подтверждения инвестора.

2) Поставка по партиям
- График состоит из N партий: каждая партия имеет объем, цену (коллатерал→лаунч), и, при необходимости, временные окна.
- Поставка может идти частями; если цена меняется между партиями, инвестор всегда получает эквивалент по заранее зафиксированным правилам.
- Если поставка прерывается (не все партии исполнены), контракт хранит «микст» (остаток коллатерала и/или уже поставленный лаунч) до итогового исхода.

3) Исходы
- Плановый исход (confirm): администратор предлагает адрес назначения; инвестор подтверждает; активы переходят в конечное место.
- Отказ инвестора (reject):
  - при отказе инвестора администратор может выполнить buyback по заранее заявленной цене;
  - если администратор не исполнил buyback до конца лока, инвестор может забрать свои активы (коллатерал/лаунч/смесь).
- Таймаут поставки:
  - если в отведенный срок (например, 10 дней) лаунч не был поставлен за коллатерал, инвестор имеет право на возврат.
  
Замечание: использование Proof of Capital‑совместимых лаунч‑токенов предпочтительно, так как они обеспечены и дополнительно защищают инвестора. Для произвольных токенов риски выше.

## Конфигурация (инициализация)

Минимальный набор параметров при деплое:
- collateralToken: адрес ERC‑20 коллатерала.
- launchToken: адрес ERC‑20 лаунча.
- tranches: массив партий с полями:
  - amountLaunch или amountCollateral (выберите инвариант),
  - price (коллатерал/лаунч в фикс. формате),
  - deadline или start/end (опционально).
- buybackPrice: цена обратного выкупа (если применяется).
- deliveryTimeout: дедлайн поставки (например, 10 дней от начала).
- lockUntil: дата/блок, до которой действует лок и ограничения на вывод.
- admin, investor: участники данного OTC (адреса).
- destinationApprovalWindow: окно для buyback после отказа.

Все цены приводите к единому масштабу с учетом decimals обоих токенов.

## Состояния (state machine)

- Init: контракт развернут, параметры зафиксированы.
- FundingCollateral: внесен коллатерал, ожидается поставка лаунча.
- FundingLaunch: лаунч внесен (частично/полностью).
- DeliveryPending: доступно достаточно лаунча для маршрутизации; ожидается адрес назначения.
- DestinationProposed: админ предложил конечный адрес.
- Completed: инвестор подтвердил, средства переведены.
- Rejected: инвестор отказал; открыт период buyback для админа.
- Expired: истек timeout/lock; инвестор может забрать свои активы.
- Cancelled: завершение без поставки (возврат).

Переходы между состояниями должны сопровождаться эвентами.

## Публичный интерфейс (пример)

Синхронизируйте сигнатуры с реализацией. Рекомендуется Solidity ^0.8.20 и OpenZeppelin SafeERC20.

- depositCollateral(uint256 amount)
- depositLaunch(uint256 amount)
- proposeDestination(address destination)
- acceptDestination() — только инвестор
- rejectDestination(uint8 reason) — только инвестор
- deliverTranche(uint256 trancheId, uint256 amountLaunch) — админ отмечает исполнение партии
- adminBuyback(uint256 amount) — по фиксированной buybackPrice
- investorWithdraw() — по истечении lock/timeout или при Expired/Cancelled
- refundOnTimeout() — если поставка не состоялась в срок
- setPause(bool status) — опционально
- rescueDust(address token, uint256 amount) — только не‑tracked токены

Пример интерфейса (обновите под код):

```solidity
interface IOTC {
    function depositCollateral(uint256 amount) external;
    function depositLaunch(uint256 amount) external;
    function proposeDestination(address dst) external;
    function acceptDestination() external;
    function rejectDestination(uint8 reason) external;
    function deliverTranche(uint256 trancheId, uint256 amountLaunch) external;
    function adminBuyback(uint256 amountCollateralOrLaunch) external;
    function investorWithdraw() external;
    function refundOnTimeout() external;
    // views
    function getTranches() external view returns (/* ... */);
    function pendingLaunchForInvestor() external view returns (uint256);
    function pendingCollateralForInvestor() external view returns (uint256);
    function state() external view returns (uint8);
}
```

## Эвенты (пример)

- CollateralDeposited(investor, amount)
- LaunchDeposited(admin, amount)
- TrancheDelivered(trancheId, amountLaunch, price)
- DestinationProposed(admin, destination)
- DestinationAccepted(investor, destination)
- DestinationRejected(investor, reason)
- BuybackExecuted(admin, investor, amount, price)
- Withdrawn(investor, collateralAmount, launchAmount)
- RefundedOnTimeout(investor, collateralAmount)
- StateChanged(prev, next)

## Ошибки и инварианты

- Нельзя принимать решения неуполномоченным адресам (модификаторы onlyAdmin/onlyInvestor).
- Нельзя предлагать новый destination, если предыдущий в ожидании ответа (либо отменить явно).
- Нельзя принимать depositLaunch после завершения или после возврата, если код таков.
- Отслеживайте decimals: все формулы цены должны использовать 18‑значную шкалу/скейлинг.
- Предусмотрите fee‑on‑transfer токены: используйте SafeERC20 и проверяйте фактически полученный amount.
- Защитите от реэнтранси (ReentrancyGuard на внешних функциях перевода).
- Тщательно обработайте частичные поставки и округления (в пользу инвестора).
- Таймауты и локи должны сравниваться по block.timestamp, учитывайте дрейф времени.

## Расчет и ценообразование

- Для партий определите один инвариант: фиксируем либо amountLaunch и price, либо amountCollateral и price. На основе этого выводится встречное значение.
- При отказе инвестора:
  - buybackPrice фиксируется при деплое (или верифицируется письменно вне ончейна) и применяется к соответствующему активу;
  - определите, что именно выкупает админ: уже поставленный лаунч у инвестора или обязательство в коллатерале (укажите в коде явно).

## Тайминги и дедлайны

- deliveryTimeout: глобальный предел с момента первого депозита (или контракта).
- lockUntil: период, в течение которого инвестор не может принудительно выводить, если процесс идет по плану.
- destinationApprovalWindow: период для ответа инвестора и/или исполнения buyback.

Все значения времени документируйте и сообщайте аудиторам.

## Безопасность

- Используйте:
  - OpenZeppelin SafeERC20, ReentrancyGuard, Ownable/AccessControl.
  - Checks-Effects-Interactions pattern.
- Ограничьте rescue функций, чтобы не трогать tracked‑активы (collateral/launch).
- Заблокируйте изменение ключевых параметров после инициализации (immutable/once).
- Логируйте все ключевые события.
- При работе с несколькими партиями обеспечьте, что суммарные amountLaunch не превышают фактический баланс контракта.
- Не доверяйте внешним ценовым оракулам в ончейне — цена фиксируется в параметрах партий.

## Развертывание

1) Подготовьте параметры:
   - адреса токенов,
   - массив партий,
   - buybackPrice,
   - lockUntil, deliveryTimeout,
   - admin, investor.
2) Задеплойте контракт и вызовите initialize (если прокси) или передайте параметры в конструктор.
3) Проверьте роли/права (Ownable/AccessControl).
4) Проведите dry‑run тесты в тестнете.

## Пример использования (ethers.js)

```ts
const otc = new ethers.Contract(otcAddress, otcAbi, signer);

// Инвестор вносит коллатерал:
await collateral.connect(investor).approve(otc.address, amount);
await otc.connect(investor).depositCollateral(amount);

// Админ вносит лаунч по партиям:
await launch.connect(admin).approve(otc.address, amountLaunch);
await otc.connect(admin).depositLaunch(amountLaunch);
await otc.connect(admin).deliverTranche(0, amountLaunchPart);

// Админ предлагает конечный адрес:
await otc.connect(admin).proposeDestination(destination);

// Инвестор подтверждает:
await otc.connect(investor).acceptDestination();

// При отказе инвестора:
await otc.connect(investor).rejectDestination(1); // reason code
await otc.connect(admin).adminBuyback(buybackAmount);

// По таймауту:
await otc.connect(investor).refundOnTimeout();
```

## Тест‑кейсы (минимальный набор)

- Happy path: collateral → launch по партиям → propose → accept → перевод в destination.
- Partial delivery: исполнение первых партий, затем подтверждение или отказ.
- Reject + buyback: отказ инвестора, buyback админа в окно.
- Reject + no‑buyback: истекло окно buyback, инвестор выводит.
- Timeout: не исполнена поставка до deliveryTimeout → инвестор получает возврат.
- Edge: fee‑on‑transfer токены, разные decimals, округления, минимальные/максимальные суммы, reentrancy‑атака на эвенты перевода.

## Пример описания партий (JSON)

```json
[
  { "trancheId": 0, "amountLaunch": "100000e18", "price": "0.80e18", "deadline": 1710000000 },
  { "trancheId": 1, "amountLaunch": "150000e18", "price": "0.95e18", "deadline": 1710600000 },
  { "trancheId": 2, "amountLaunch": "250000e18", "price": "1.10e18", "deadline": 1711200000 }
]
```

Пояснение: цена указывается как коллатерал на 1 единицу лаунча (нормализовано к 18 знакам). При росте цены в следующих партиях инвестор «успевает» купить часть дешевле и часть дороже; если поставка прервется, средневзвешенная цена соответствует исполненным партиям.

## Примечания по Proof of Capital

- Приоритетно использовать лаунч‑токены, обеспеченные по Proof of Capital: инвестор всегда владеет либо коллатералом, либо обеспеченным лаунчем.
- Для обычных токенов явно донесите риски до пользователя и введите доп. лимиты/страховки при необходимости.

## Ограничения и дисклеймер

- README описывает целевую логику. Точная семантика зависит от вашей реализации.
- Перед продакшеном проведите независимый аудит, нагрузочное тестирование и формальную верификацию критичных инвариантов.

## Структура репозитория (рекомендация)

- contracts/OTC.sol
- contracts/libs/…
- scripts/deploy.ts
- test/otc.spec.ts
- README.md (этот файл)
- SECURITY.md (процедуры раскрытия уязвимостей)
- AUDIT.md (отчет/замечания аудиторов)
- configs/tranches.mainnet.json

---

Если пришлете точные сигнатуры функций/эвентов и особенности вашей реализации (например, кто именно хранит поставленный лаунч до подтверждения, как именно считается buyback), я обновлю README под ваш код, добавлю примеры вызовов и уточню инварианты.